name: Deploy to GitHub Pages

on:
  push:
    branches:
      - master
  schedule:
    - cron: '0 6 * * *' # daily at 06:00 UTC
  workflow_dispatch: {}

permissions:
  contents: read
  pages: write
  id-token: write


jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if CV needs compiling
        id: check_cv
        run: |
          if [ ! -f docs/resume.pdf ] || [ cv-latex/cv.tex -nt docs/resume.pdf ]; then
            echo "NEED_COMPILE=true" >> $GITHUB_ENV
          else
            echo "NEED_COMPILE=false" >> $GITHUB_ENV
          fi

      - name: Compile CV
        if: env.NEED_COMPILE == 'true'
        uses: xu-cheng/texlive-action@v2
        with:
          scheme: full
          run: bash ${GITHUB_WORKSPACE}/cv-latex/build

      - name: Update citations
        run: |
          cd data/
          python3 update_citations.py

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4